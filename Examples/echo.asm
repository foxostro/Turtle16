# let kSerialInterface = 6
# let kIORegister = 0
# let kControlRegister = 2

LI A, 0
LI B, 0
LI X, 0
LI Y, 0
LI U, 0
LI V, 0

LXY serial_init
JALR
NOP
NOP

LI A, 'r'
LXY serial_put
JALR
NOP
NOP

LI A, 'e'
LXY serial_put
JALR
NOP
NOP

LI A, 'a'
LXY serial_put
JALR
NOP
NOP

LI A, 'd'
LXY serial_put
JALR
NOP
NOP

LI A, 'y'
LXY serial_put
JALR
NOP
NOP

LI A, '.'
LXY serial_put
JALR
NOP
NOP

LI A, 10
LXY serial_put
JALR
NOP
NOP


# Now, we enter a loop where we wait for serial input and then echo it to
# serial output.

beginningOfInputLoop:

waitForInput:
LI A, 2 # kControlRegister
LXY serial_get
JALR
NOP
NOP
LI B, 0
CMP
LXY waitForInput
JE
NOP
NOP

# Read a byte and echo it back.
LI A, 0 # kIORegister
LXY serial_get
JALR
NOP
NOP

LXY serial_put
JALR
NOP
NOP

LXY beginningOfInputLoop
JMP
NOP
NOP






serial_init:

MOV U, G
MOV V, H

LI A, 2 # kControlRegister
LI A, 'r'

MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP

MOV X, U
MOV Y, V
JMP
NOP
NOP





serial_put:

MOV P, A # "A" holds the value to output...
LI Y, 0 # kIORegister
LI D, 6 # kSerialInterface

MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
MOV P, A
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP

MOV X, G
MOV Y, H
JMP
NOP
NOP


serial_get:

MOV Y, A # "A" holds the port on which to listen...
LI D, 6 # kSerialInterface

MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
MOV A, P
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP
NOP

MOV X, G
MOV Y, H
JMP
NOP
NOP

